parameters:
  minrust: 1.32.0 # Rust 2018 with uniform paths
  setup: []
  services: {}
  env: {}
  cross: true
  dir: "."
  check_all_features: true
  check_no_features: true

jobs:
  - job: style
    displayName: Style linting
    strategy:
      matrix:
        stable:
          rust: stable
        beta:
          rust: beta
    pool:
      vmImage: ubuntu-18.04
    continueOnError: true
    steps:
      - template: install-rust.yml@templates
        parameters:
          rust: $(rust)
          components:
            - rustfmt
            - clippy
      # Run any user-specific setup steps
      - ${{ parameters.setup }}
      - script: cargo fmt --all -- --check
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo fmt --check
      - script: cargo clippy --all
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo clippy -- -D warnings
  - job: main
    displayName: Compile and test
    dependsOn: []
    ${{ if eq('true', parameters.cross) }}:
      strategy:
        matrix:
          # "Linux (nightly)":
          #   vmImage: ubuntu-18.04
          #   rust: nightly
          # "Linux (beta)":
          #   vmImage: ubuntu-18.04
          #   rust: beta
          Linux:
            vmImage: ubuntu-18.04
            rust: stable
          # MacOS:
          #   vmImage: macOS-10.15
          #   rust: stable
          # Windows:
          #   vmImage: windows-2019
          #   rust: stable
    ${{ if ne('true', parameters.cross) }}:
      strategy:
        matrix:
          "Linux (nightly)":
            vmImage: ubuntu-18.04
            rust: nightly
          "Linux (beta)":
            vmImage: ubuntu-18.04
            rust: beta
          Linux:
            vmImage: ubuntu-18.04
            rust: stable
    pool:
      vmImage: $(vmImage)
    services:
      ${{ insert }}: ${{ parameters.services }}
    continueOnError: $[eq(variables.rust, 'nightly')]
    variables:
      CARGO_CACHE_FOLDER: $(Agent.HomeDirectory)/.cargo
    steps:
      - template: install-rust.yml@templates
        parameters:
          rust: $(rust)
      # Linux and macOS.
      - script: |
          set CARGOPATH $HOME/.cargo/bin
          echo "##vso[task.setvariable variable=CARGOPATH;]$HOME/.cargo/bin"
          echo $CARGOPATH
        env:
          RUSTUP_TOOLCHAIN: ${{parameters.rust}}
        displayName: "Set Cargo Path (*nix)"
        condition: not(eq(variables['Agent.OS'], 'Windows_NT'))
      # Necessary for now for the cargo cache:
      # https://github.com/actions/cache/issues/133#issuecomment-599102035
      - script: sudo chown -R $(whoami):$(id -ng) $(CARGOPATH)
        displayName: Fix .cargo directory permissions
        condition: not(eq(variables['Agent.OS'], 'Windows_NT'))
      # Windows.
      - script: |
          set CARGOPATH=%USERPROFILE%\.cargo\bin
          echo "##vso[task.setvariable variable=CARGOPATH;]%USERPROFILE%\.cargo\bin"
          echo %CARGOPATH%
        env:
          RUSTUP_TOOLCHAIN: ${{parameters.rust}}
        displayName: "Set Cargo Path (windows)"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
      - task: Cache@2
        displayName: Cache cargo registry
        inputs:
          # The key must be one liner, each segment separated by pipe, non-path segments enclosed by
          # double quotes.
          key: $(Build.SourcesDirectory)/Cargo.toml | $(Build.SourcesDirectory)/Cargo.lock | "$(Agent.OS)" | $(rust)
          path: $(CARGOPATH)
      - task: Bash@3
        displayName: "Set Up Build Variables"
        env:
          AGENTOS: $(Agent.OS)
          AGENTARCH: $(Agent.OSArchitecture)
        inputs:
          targetType: inline
          script: |
            gitCurrentTag=$(git tag --points-at HEAD --sort -version:refname | head -1)
            gitShortHash=$(git describe --long --always --dirty)
            gitVersion=`if [[ -z $gitCurrentTag ]]; then echo $gitShortHash; else echo $gitCurrentTag; fi;`
            echo "##vso[task.setvariable variable=gitCurrentTag]$gitCurrentTag"
            echo "##vso[task.setvariable variable=gitVersion]$gitVersion"
            echo "##vso[task.setvariable variable=cliBuildName]intiface-cli-rs-$AGENTOS-$AGENTARCH-$gitVersion"
            echo "Git Current Tag: $gitCurrentTag"
            echo "Git Short Hash: $gitShortHash"
            echo "Git Version for Build: $gitVersion"
            echo "CLI Name: intiface-cli-rs-$AGENTOS-$AGENTARCH-$gitVersion"
      # Run any user-specific setup steps
      - ${{ parameters.setup }}
      - script: cargo check
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo check
      - script: cargo check --no-default-features
        condition: ${{ parameters.check_no_features }}
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo check --no-default-features
      - script: cargo check --all-features
        condition: ${{ parameters.check_all_features }}
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo check --all-features
      - script: cargo test --all-features
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo test
        env:
          ${{ insert }}: ${{ parameters.env }}
      - script: cargo build --release
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo build --release
        env:
          ${{ insert }}: ${{ parameters.env }}        
      - script: cargo doc --no-deps
        workingDirectory: ${{ parameters.dir }}
        displayName: cargo doc
      - task: CopyFiles@2
        condition: eq(variables.rust, 'stable')
        displayName: "Copy frozen executables to staging"
        inputs:
          sourceFolder: "$(System.DefaultWorkingDirectory)/target/release"
          contents: |
            intiface-cli
            intiface-cli.exe
          targetFolder: '$(Build.ArtifactStagingDirectory)'
          flattenFolders: true
      - task: ArchiveFiles@2
        condition: eq(variables.rust, 'stable')
        inputs:
          rootFolderOrFile: "$(Build.ArtifactStagingDirectory)"
          archiveFile: '$(Build.ArtifactStagingDirectory)/$(cliBuildName).zip'
          includeRootFolder: false
          archiveType: 'zip'
      - task: PublishPipelineArtifact@0
        condition: eq(variables.rust, 'stable')
        displayName: "Publish frozen executables to artifacts"
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)'
          artifactName: '$(cliBuildName)'        
  - ${{ if ne('false', parameters.minrust) }}:
    - job: msrv
      displayName: "${{ format('Minimum supported Rust version: {0}', parameters.minrust) }}"
      dependsOn: []
      # This represents the minimum Rust version supported.
      # Tests are not run as tests may require newer versions of rust.
      pool:
        vmImage: ubuntu-18.04
      steps:
        - template: install-rust.yml@templates
          parameters:
            rust: ${{ parameters.minrust }}
        # Run any user-specific setup steps
        - ${{ parameters.setup }}
        - script: cargo check
          workingDirectory: ${{ parameters.dir }}
          displayName: cargo check
        - script: cargo check --no-default-features
          workingDirectory: ${{ parameters.dir }}
          displayName: cargo check --no-default-features
        - script: cargo check --all-features
          workingDirectory: ${{ parameters.dir }}
          displayName: cargo check --all-features
  - ${{ if ne('', parameters.codecov_token) }}:
    - template: coverage.yml@templates
      parameters:
        token: ${{ parameters.codecov_token }}
        setup: ${{ parameters.setup }}
        services: ${{ parameters.services }}
        env: ${{ parameters.env }}
        dir: ${{ parameters.dir }}

 
